Parameters:
  name:         EventCombine
  comment:      "Top level calorimeter chain"
  nEvents:      $nevents
  nEventsMax:   400
  nRepeat:      $nrepeat
  RunMC:        6
  RunRaw:       329
  OutDir:       /sphenix/lustre01/sphnxpro/scratch
  nFilesPerJob: 12
  macro:        Fun4All_Combiner.C
  memory:       2048
  cpuTimePerEvent: 75000
  maxAttempt:   3

Resources:
  - file: /sphenix/u/sphnxpro/macros/eventcombine/Fun4All_Combiner.C

InputDataSets:
  - name: topInputDS
    datasets: ebinputs

OutputDataSets:
  - name: EventCombine/outDS
    filelist:
      - "regex|beam_emcal*"

JobCommands: |-
  # Initialize environment... using the "build" environment, unless it
  # was not specified
  if [ -z ${build+x} ]; then 
     echo "build is unset [default to latest]"
     source /opt/sphenix/core/bin/sphenix_setup.sh -n 
  else 
     echo "build is set to ${build}"
     source /opt/sphenix/core/bin/sphenix_setup.sh -n ${build}
  fi  

  echo ..........................................................................
  echo Running ${name} ${runNumber} $@
  echo ..........................................................................

  # Input is a dataset of empty files... but really, we ignore it.  The sebXX.list files should be
  # packed and ready to go.  And PanDA seems to keep losing track of where rucio stashes the input
  # data sets...
  ln -s __pack/*.seb00 seb00.list
  ln -s __pack/*.seb01 seb01.list
  ln -s __pack/*.seb02 seb02.list
  ln -s __pack/*.seb03 seb03.list
  ln -s __pack/*.seb04 seb04.list
  ln -s __pack/*.seb05 seb05.list
  ln -s __pack/*.seb06 seb06.list
  ln -s __pack/*.seb07 seb07.list
  ln -s __pack/*.hcaleast hcaleast.list
  ln -s __pack/*.hcalwest hcalwest.list
  ln -s __pack/*.zdc zdc.list
  ln -s __pack/*.mbd mbd.list

  ls -la

  # Make sure we keep each run in its own scratch space on lustre
  target=${OutDir}/${runNumber}
  mkdir ${target}

  # Run fun4all
  root -q -b ${macro}\(${nEvents},\"seb00.list\",\"seb01.list\",\"seb02.list\",\"seb03.list\",\"seb04.list\",\"seb05.list\",\"seb06.list\",\"seb07.list\",\"hcaleast.list\",\"hcalwest.list\",\"zdc.list\",\"mbd.list\",\"${target}\"\)

  # Link back all of the output files so that PanDA can find them / and handle
  # the transfer to rucio
  ln -s ${target}/*.prdf .

  DBTAG=${dbtag:-ptid${PanDA_TaskID}}
  BUILDTAG=${build/./}
  FILETAG=${BUILDTAG}_${DBTAG}

  for fname in *.prdf
  do
      mv ${fname} ${fname/beam_emcal/beam_emcal_${FILETAG}}
  done

  stash_job_log
  





